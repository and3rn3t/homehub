<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Dashboard Debug - HomeHub</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        max-width: 1400px;
        margin: 20px auto;
        padding: 20px;
        background: #0a0a0a;
        color: #fff;
      }
      h1 {
        color: #4a9eff;
      }
      h2 {
        color: #10b981;
        margin-top: 25px;
      }
      .section {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .status {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        margin: 8px 0;
      }
      .success {
        background: #10b981;
        color: #fff;
      }
      .error {
        background: #ef4444;
        color: #fff;
      }
      .warning {
        background: #f59e0b;
        color: #fff;
      }
      .info {
        background: #3b82f6;
        color: #fff;
      }
      pre {
        background: #000;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
        overflow-x: auto;
        font-size: 12px;
        line-height: 1.5;
        max-height: 400px;
      }
      button {
        background: #4a9eff;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #3b8fd9;
      }
      button.danger {
        background: #ef4444;
      }
      button.danger:hover {
        background: #dc2626;
      }
      button.success {
        background: #10b981;
      }
      button.success:hover {
        background: #059669;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }
      .card {
        background: #000;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
      }
      .card h3 {
        color: #4a9eff;
        margin-top: 0;
        font-size: 16px;
      }
      .value {
        font-size: 24px;
        font-weight: bold;
        color: #10b981;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>üîç Live Dashboard Debug</h1>

    <div class="section">
      <h2>Quick Actions</h2>
      <button onclick="checkAll()">üîÑ Refresh All</button>
      <button onclick="copyDevicesToKV()" class="success">üìã Copy "devices" ‚Üí "kv:devices"</button>
      <button onclick="clearAll()" class="danger">üóëÔ∏è Clear All Storage</button>
      <button onclick="window.open('http://localhost:5173', '_blank')">
        üè† Open Dashboard (New Tab)
      </button>
    </div>

    <div class="section">
      <h2>1. LocalStorage Keys Status</h2>
      <div id="keys-status"></div>
    </div>

    <div class="section">
      <h2>2. Device Data by Key</h2>
      <div class="grid" id="device-data"></div>
    </div>

    <div class="section">
      <h2>3. What useKV Hook Will Return</h2>
      <div id="hook-sim"></div>
    </div>

    <div class="section">
      <h2>4. Browser Console Script</h2>
      <p style="color: #ccc">
        Copy this script and run it in the Dashboard's browser console (F12) to see what's
        happening:
      </p>
      <pre
        id="console-script"
        style="user-select: all; cursor: pointer"
        onclick="copyToClipboard(this.textContent)"
      >
// Click to copy this script
console.clear();
console.log('üîç Dashboard Debug');
console.log('==================');

// Check localStorage
console.log('\nüì¶ LocalStorage Keys:');
const keys = ['devices', 'kv:devices', 'kv:DEVICES'];
keys.forEach(key => {
  const data = localStorage.getItem(key);
  if (data) {
    try {
      const parsed = JSON.parse(data);
      console.log(`‚úÖ ${key}: ${Array.isArray(parsed) ? parsed.length + ' devices' : typeof parsed}`);
      if (Array.isArray(parsed)) {
        const hue = parsed.filter(d => d.protocol === 'hue');
        console.log(`   ‚îî‚îÄ Hue devices: ${hue.length}`);
      }
    } catch {
      console.log(`‚ùå ${key}: Invalid JSON`);
    }
  } else {
    console.log(`‚ùå ${key}: Not found`);
  }
});

// Check what the hook would load
console.log('\nüé£ useKV Hook Simulation:');
const kvKey = 'kv:devices';
const stored = localStorage.getItem(kvKey);
if (stored) {
  console.log(`‚úÖ Hook will load from "${kvKey}"`);
} else {
  console.log(`‚ö†Ô∏è Hook will use default value (empty array)`);
  console.log('   Tip: Run copyDevicesToKV() to fix this');
}

console.log('\n‚ú® Check complete!');</pre
      >
      <p style="margin-top: 10px; font-size: 13px; color: #888">Click the code above to copy it</p>
    </div>

    <script>
      function checkAll() {
        checkKeys()
        checkDeviceData()
        simulateHook()
      }

      function checkKeys() {
        const keysDiv = document.getElementById('keys-status')
        const allKeys = Object.keys(localStorage)
        const deviceKeys = ['devices', 'kv:devices', 'kv:DEVICES']

        let html = `<p>Total localStorage keys: <strong>${allKeys.length}</strong></p>`
        html += '<div style="margin-top: 15px;">'

        deviceKeys.forEach(key => {
          const exists = localStorage.getItem(key)
          if (exists) {
            try {
              const parsed = JSON.parse(exists)
              const count = Array.isArray(parsed) ? parsed.length : '?'
              html += `<div class="status success">‚úÖ ${key}: ${count} items</div><br>`
            } catch {
              html += `<div class="status error">‚ùå ${key}: Invalid JSON</div><br>`
            }
          } else {
            html += `<div class="status warning">‚ö†Ô∏è ${key}: Not found</div><br>`
          }
        })

        html += '</div>'
        keysDiv.innerHTML = html
      }

      function checkDeviceData() {
        const dataDiv = document.getElementById('device-data')
        const keys = ['devices', 'kv:devices']

        let html = ''
        keys.forEach(key => {
          const data = localStorage.getItem(key)
          html += '<div class="card">'
          html += `<h3>"${key}"</h3>`

          if (!data) {
            html += '<p style="color: #f59e0b;">‚ùå No data</p>'
          } else {
            try {
              const parsed = JSON.parse(data)
              if (Array.isArray(parsed)) {
                const hueDevices = parsed.filter(d => d.protocol === 'hue')
                const onlineDevices = parsed.filter(d => d.status === 'online')

                html += `<div class="value">${parsed.length}</div>`
                html += '<p>Total Devices</p>'
                html += `<p style="margin-top: 10px; color: #888;">`
                html += `‚Ä¢ Hue: ${hueDevices.length}<br>`
                html += `‚Ä¢ Online: ${onlineDevices.length}<br>`
                html += `‚Ä¢ Size: ${(data.length / 1024).toFixed(1)} KB`
                html += `</p>`
              } else {
                html += `<p style="color: #f59e0b;">Not an array</p>`
              }
            } catch (error) {
              html += `<p style="color: #ef4444;">Parse error: ${error.message}</p>`
            }
          }

          html += '</div>'
        })

        dataDiv.innerHTML = html
      }

      function simulateHook() {
        const hookDiv = document.getElementById('hook-sim')

        // This simulates what useKV does
        const key = 'devices' // What Dashboard passes
        const fullKey = `kv:${key}` // What hook looks for

        const stored = localStorage.getItem(fullKey)

        let html =
          '<div style="background: #000; border: 1px solid #333; border-radius: 8px; padding: 20px;">'
        html += '<h3 style="color: #4a9eff; margin-top: 0;">Hook Simulation</h3>'
        html += `<p style="color: #888;">Dashboard calls: <code>useKV("${key}", [])</code></p>`
        html += `<p style="color: #888;">Hook looks for: <code>localStorage.getItem("${fullKey}")</code></p>`
        html += '<hr style="border: 1px solid #333; margin: 15px 0;">'

        if (stored) {
          try {
            const parsed = JSON.parse(stored)
            const count = Array.isArray(parsed) ? parsed.length : '?'
            html += `<div class="status success">‚úÖ Found ${count} devices</div>`
            html += `<p style="margin-top: 15px; color: #10b981;">Dashboard WILL show devices!</p>`
          } catch {
            html += `<div class="status error">‚ùå Invalid JSON</div>`
            html += `<p style="margin-top: 15px; color: #ef4444;">Data is corrupted!</p>`
          }
        } else {
          html += `<div class="status error">‚ùå Key "${fullKey}" not found</div>`
          html += `<p style="margin-top: 15px; color: #ef4444;">Dashboard will show 0 devices (using default empty array)</p>`

          // Check if data exists at wrong key
          const wrongKey = localStorage.getItem('devices')
          if (wrongKey) {
            html += `<p style="margin-top: 15px; color: #f59e0b;">‚ö†Ô∏è But data DOES exist at "devices" key!</p>`
            html += `<p style="color: #f59e0b;">Click "Copy devices ‚Üí kv:devices" above to fix this.</p>`
          }
        }

        html += '</div>'
        hookDiv.innerHTML = html
      }

      function copyDevicesToKV() {
        try {
          const source = localStorage.getItem('devices')
          if (!source) {
            alert('‚ùå No data found at "devices" key')
            return
          }

          // Validate JSON
          const parsed = JSON.parse(source)
          if (!Array.isArray(parsed)) {
            alert('‚ùå Data is not an array')
            return
          }

          // Copy to kv:devices
          localStorage.setItem('kv:devices', source)

          alert(
            `‚úÖ Copied ${parsed.length} devices to "kv:devices"!\n\nNow refresh the Dashboard (Ctrl+Shift+R)`
          )
          checkAll()
        } catch (error) {
          alert(`‚ùå Error: ${error.message}`)
        }
      }

      function clearAll() {
        if (confirm('‚ö†Ô∏è This will delete ALL localStorage data!\n\nAre you sure?')) {
          localStorage.clear()
          alert('üóëÔ∏è All localStorage cleared')
          checkAll()
        }
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          alert('‚úÖ Copied to clipboard! Paste it in the Dashboard console (F12)')
        })
      }

      // Run checks on load
      checkAll()
    </script>
  </body>
</html>
