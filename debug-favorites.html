<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Favorites</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        max-width: 1200px;
        margin: 2rem auto;
        padding: 1rem;
        background: #0a0a0a;
        color: #fff;
      }
      .section {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
      }
      h2 {
        margin-top: 0;
        color: #4a9eff;
      }
      pre {
        background: #000;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 0.875rem;
      }
      .key {
        color: #22c55e;
      }
      .value {
        color: #f59e0b;
      }
      button {
        background: #4a9eff;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
      }
      button:hover {
        background: #3a8eef;
      }
      .error {
        color: #ef4444;
      }
      .success {
        color: #22c55e;
      }
      .warning {
        color: #f59e0b;
      }
    </style>
  </head>
  <body>
    <h1>üîç Favorites Debug Tool</h1>

    <div class="section">
      <h2>üìä Current Storage State</h2>
      <button onclick="checkStorage()">Refresh Data</button>
      <button onclick="clearFavorites()">Clear Favorites</button>
      <button onclick="fixFavorites()">Auto-Fix Favorites</button>
      <div id="storage-output"></div>
    </div>

    <div class="section">
      <h2>üìù All Devices</h2>
      <div id="devices-output"></div>
    </div>

    <div class="section">
      <h2>‚≠ê Favorite Devices</h2>
      <div id="favorites-output"></div>
    </div>

    <div class="section">
      <h2>üîß Actions</h2>
      <button onclick="addAllToFavorites()">Add All Devices to Favorites</button>
      <button onclick="addFirstThreeToFavorites()">Add First 3 Devices to Favorites</button>
      <div id="actions-output"></div>
    </div>

    <script>
      function checkStorage() {
        const output = document.getElementById('storage-output')
        const devicesOutput = document.getElementById('devices-output')
        const favoritesOutput = document.getElementById('favorites-output')

        // Check all localStorage keys
        const allKeys = Object.keys(localStorage).filter(k => k.startsWith('kv:'))

        let html = '<pre>'
        html += '<strong>All KV Keys in localStorage:</strong>\n'
        allKeys.forEach(key => {
          html += `<span class="key">${key}</span>\n`
        })
        html += '</pre>'

        // Check devices
        const devicesKey = 'kv:devices'
        const devicesRaw = localStorage.getItem(devicesKey)

        if (devicesRaw) {
          try {
            const devices = JSON.parse(devicesRaw)
            html += `<pre><strong>Devices (${devices.length}):</strong>\n${JSON.stringify(devices.slice(0, 5), null, 2)}\n... (showing first 5)</pre>`

            // Display all devices
            devicesOutput.innerHTML = '<pre>' + JSON.stringify(devices, null, 2) + '</pre>'
          } catch (e) {
            html += `<pre class="error">Error parsing devices: ${e.message}</pre>`
          }
        } else {
          html += '<pre class="warning">No devices found in localStorage</pre>'
          devicesOutput.innerHTML = '<p class="warning">No devices found</p>'
        }

        // Check favorites
        const favoritesKey = 'kv:favorite-devices'
        const favoritesRaw = localStorage.getItem(favoritesKey)

        if (favoritesRaw) {
          try {
            const favorites = JSON.parse(favoritesRaw)
            html += `<pre><strong class="success">Favorites (${Array.isArray(favorites) ? favorites.length : 'not an array'}):</strong>\n${JSON.stringify(favorites, null, 2)}</pre>`

            // Check if favorites match device IDs
            if (devicesRaw && Array.isArray(favorites)) {
              const devices = JSON.parse(devicesRaw)
              const deviceIds = devices.map(d => d.id)
              const matchingIds = favorites.filter(id => deviceIds.includes(id))
              const nonMatchingIds = favorites.filter(id => !deviceIds.includes(id))

              html += `<pre><strong>Matching Device IDs:</strong> ${matchingIds.length} / ${favorites.length}\n`
              if (nonMatchingIds.length > 0) {
                html += `<span class="error">Non-matching IDs:</span>\n${JSON.stringify(nonMatchingIds, null, 2)}</pre>`
              } else {
                html += '<span class="success">All favorite IDs match device IDs ‚úì</span></pre>'
              }

              // Show favorite devices
              const favoriteDevices = devices.filter(d => favorites.includes(d.id))
              favoritesOutput.innerHTML =
                '<pre>' + JSON.stringify(favoriteDevices, null, 2) + '</pre>'
            }
          } catch (e) {
            html += `<pre class="error">Error parsing favorites: ${e.message}</pre>`
          }
        } else {
          html += '<pre class="warning">No favorites found in localStorage</pre>'
          favoritesOutput.innerHTML = '<p class="warning">No favorites found</p>'
        }

        output.innerHTML = html
      }

      function clearFavorites() {
        localStorage.removeItem('kv:favorite-devices')
        document.getElementById('actions-output').innerHTML =
          '<p class="success">Favorites cleared! Refresh to see changes.</p>'
        checkStorage()
      }

      function fixFavorites() {
        const devicesRaw = localStorage.getItem('kv:devices')
        if (!devicesRaw) {
          document.getElementById('actions-output').innerHTML =
            '<p class="error">No devices found to fix!</p>'
          return
        }

        try {
          const devices = JSON.parse(devicesRaw)
          const deviceIds = devices.map(d => d.id)

          // Take first 4 devices as favorites
          const newFavorites = deviceIds.slice(0, 4)
          localStorage.setItem('kv:favorite-devices', JSON.stringify(newFavorites))

          document.getElementById('actions-output').innerHTML =
            `<p class="success">Fixed! Set ${newFavorites.length} devices as favorites. Refresh the dashboard to see changes.</p>`
          checkStorage()
        } catch (e) {
          document.getElementById('actions-output').innerHTML =
            `<p class="error">Error: ${e.message}</p>`
        }
      }

      function addAllToFavorites() {
        const devicesRaw = localStorage.getItem('kv:devices')
        if (!devicesRaw) {
          document.getElementById('actions-output').innerHTML =
            '<p class="error">No devices found!</p>'
          return
        }

        try {
          const devices = JSON.parse(devicesRaw)
          const allIds = devices.map(d => d.id)
          localStorage.setItem('kv:favorite-devices', JSON.stringify(allIds))

          document.getElementById('actions-output').innerHTML =
            `<p class="success">Added all ${allIds.length} devices to favorites!</p>`
          checkStorage()
        } catch (e) {
          document.getElementById('actions-output').innerHTML =
            `<p class="error">Error: ${e.message}</p>`
        }
      }

      function addFirstThreeToFavorites() {
        const devicesRaw = localStorage.getItem('kv:devices')
        if (!devicesRaw) {
          document.getElementById('actions-output').innerHTML =
            '<p class="error">No devices found!</p>'
          return
        }

        try {
          const devices = JSON.parse(devicesRaw)
          const firstThree = devices.slice(0, 3).map(d => d.id)
          localStorage.setItem('kv:favorite-devices', JSON.stringify(firstThree))

          document.getElementById('actions-output').innerHTML =
            `<p class="success">Added first 3 devices to favorites!</p>`
          checkStorage()
        } catch (e) {
          document.getElementById('actions-output').innerHTML =
            `<p class="error">Error: ${e.message}</p>`
        }
      }

      // Auto-check on load
      checkStorage()
    </script>
  </body>
</html>
