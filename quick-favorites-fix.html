<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quick Favorites Fix - HomeHub</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px 20px;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .container {
        max-width: 800px;
        width: 100%;
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        font-size: 36px;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 12px;
        text-align: center;
      }

      .subtitle {
        color: #718096;
        margin-bottom: 40px;
        font-size: 18px;
        text-align: center;
      }

      .status-box {
        padding: 24px;
        border-radius: 12px;
        margin-bottom: 24px;
        font-size: 16px;
        line-height: 1.6;
      }

      .status-info {
        background: #bee3f8;
        border: 2px solid #4299e1;
        color: #2c5282;
      }

      .status-success {
        background: #c6f6d5;
        border: 2px solid #48bb78;
        color: #22543d;
      }

      .status-error {
        background: #fed7d7;
        border: 2px solid #f56565;
        color: #742a2a;
      }

      .status-warning {
        background: #fef5e7;
        border: 2px solid #f6e05e;
        color: #744210;
      }

      .btn {
        width: 100%;
        padding: 20px;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-success {
        background: #48bb78;
        color: white;
      }

      .code {
        background: #2d3748;
        color: #68d391;
        padding: 16px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        margin: 16px 0;
        overflow-x: auto;
        white-space: pre-wrap;
      }

      .device-list {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
      }

      .device-item {
        padding: 12px;
        background: white;
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .device-icon {
        font-size: 24px;
      }

      .device-info {
        flex: 1;
      }

      .device-name {
        font-weight: 600;
        color: #2d3748;
      }

      .device-id {
        font-size: 12px;
        color: #718096;
        font-family: 'Courier New', monospace;
      }

      .step-number {
        display: inline-block;
        width: 32px;
        height: 32px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 32px;
        font-weight: 700;
        margin-right: 8px;
      }

      .steps {
        margin: 24px 0;
      }

      .step {
        margin-bottom: 16px;
        font-size: 16px;
        color: #2d3748;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Quick Favorites Fix</h1>
      <p class="subtitle">One-click solution to get favorites working</p>

      <div id="status"></div>

      <button id="fixBtn" class="btn btn-primary" onclick="fixFavorites()">
        ‚ö° Auto-Fix Favorites Now
      </button>

      <div id="results"></div>

      <div class="steps">
        <h3 style="margin-bottom: 16px; color: #2d3748">What this does:</h3>
        <div class="step">
          <span class="step-number">1</span>
          Reads all devices from localStorage
        </div>
        <div class="step">
          <span class="step-number">2</span>
          Finds 5 Extended Color Hue lights
        </div>
        <div class="step">
          <span class="step-number">3</span>
          Saves their IDs to favorites (both kv: and legacy keys)
        </div>
        <div class="step">
          <span class="step-number">4</span>
          Verifies the fix worked
        </div>
        <div class="step">
          <span class="step-number">5</span>
          Tells you to refresh Dashboard
        </div>
      </div>
    </div>

    <script>
      function fixFavorites() {
        const statusDiv = document.getElementById('status')
        const resultsDiv = document.getElementById('results')
        const fixBtn = document.getElementById('fixBtn')

        fixBtn.disabled = true
        fixBtn.innerHTML = '‚è≥ Working...'

        resultsDiv.innerHTML = ''

        // Step 1: Read devices
        statusDiv.innerHTML = `
                <div class="status-box status-info">
                    <strong>Step 1/5:</strong> Reading devices from localStorage...
                </div>
            `

        let devices = []
        const kvDevices = localStorage.getItem('kv:devices')
        const legacyDevices = localStorage.getItem('devices')

        if (kvDevices) {
          try {
            devices = JSON.parse(kvDevices)
            console.log('‚úÖ Found devices in kv:devices:', devices.length)
          } catch (e) {
            console.error('‚ùå Failed to parse kv:devices', e)
          }
        } else if (legacyDevices) {
          try {
            devices = JSON.parse(legacyDevices)
            console.log('‚úÖ Found devices in legacy devices key:', devices.length)
          } catch (e) {
            console.error('‚ùå Failed to parse devices', e)
          }
        }

        if (devices.length === 0) {
          statusDiv.innerHTML = `
                    <div class="status-box status-error">
                        <strong>‚ùå ERROR:</strong> No devices found in localStorage!<br><br>
                        You need to import devices first:<br>
                        1. Open <code>reimport-hue-devices.html</code><br>
                        2. Click "Import Devices from Hue Bridge"<br>
                        3. Come back here and try again
                    </div>
                `
          fixBtn.disabled = false
          fixBtn.innerHTML = '‚ö° Auto-Fix Favorites Now'
          return
        }

        // Step 2: Find color lights
        setTimeout(() => {
          statusDiv.innerHTML = `
                    <div class="status-box status-info">
                        <strong>Step 2/5:</strong> Finding Extended Color lights...<br>
                        Total devices: ${devices.length}
                    </div>
                `

          const colorLights = devices.filter(d => {
            // Check if device has color capability
            return (
              d.capabilities && Array.isArray(d.capabilities) && d.capabilities.includes('color')
            )
          })

          console.log('üé® Color lights found:', colorLights.length)
          console.log(
            'Color lights:',
            colorLights.map(d => ({ id: d.id, name: d.name, caps: d.capabilities }))
          )

          if (colorLights.length === 0) {
            statusDiv.innerHTML = `
                        <div class="status-box status-error">
                            <strong>‚ö†Ô∏è WARNING:</strong> No color-capable devices found!<br><br>
                            Using any 5 devices instead...
                        </div>
                    `
          }

          const selectedDevices =
            colorLights.length >= 5
              ? colorLights.slice(0, 5)
              : devices.slice(0, Math.min(5, devices.length))

          console.log(
            'üìã Selected devices:',
            selectedDevices.map(d => d.id)
          )

          // Step 3: Save favorites
          setTimeout(() => {
            statusDiv.innerHTML = `
                        <div class="status-box status-info">
                            <strong>Step 3/5:</strong> Saving favorites to localStorage...
                        </div>
                    `

            const favoriteIds = selectedDevices.map(d => d.id)

            // Save to BOTH keys
            localStorage.setItem('kv:favorite-devices', JSON.stringify(favoriteIds))
            localStorage.setItem('favorite-devices', JSON.stringify(favoriteIds))

            console.log('‚úÖ Saved favorites:', favoriteIds)
            console.log('‚úÖ kv:favorite-devices:', localStorage.getItem('kv:favorite-devices'))
            console.log('‚úÖ favorite-devices:', localStorage.getItem('favorite-devices'))

            // Step 4: Verify
            setTimeout(() => {
              statusDiv.innerHTML = `
                            <div class="status-box status-info">
                                <strong>Step 4/5:</strong> Verifying the fix...
                            </div>
                        `

              const verifyKv = localStorage.getItem('kv:favorite-devices')
              const verifyLegacy = localStorage.getItem('favorite-devices')

              let verified = false
              try {
                const kvFavs = JSON.parse(verifyKv)
                const legacyFavs = JSON.parse(verifyLegacy)
                verified =
                  kvFavs.length === favoriteIds.length && legacyFavs.length === favoriteIds.length
              } catch (e) {
                console.error('‚ùå Verification failed', e)
              }

              // Step 5: Done!
              setTimeout(() => {
                if (verified) {
                  statusDiv.innerHTML = `
                                    <div class="status-box status-success">
                                        <strong>‚úÖ SUCCESS!</strong> Favorites have been fixed!<br><br>
                                        <strong>${selectedDevices.length} devices</strong> added to favorites
                                    </div>
                                `

                  resultsDiv.innerHTML = `
                                    <div class="device-list">
                                        <h3 style="margin-bottom: 16px; color: #2d3748;">‚≠ê Your New Favorites:</h3>
                                        ${selectedDevices
                                          .map(
                                            d => `
                                            <div class="device-item">
                                                <span class="device-icon">üí°</span>
                                                <div class="device-info">
                                                    <div class="device-name">${d.name}</div>
                                                    <div class="device-id">${d.id}</div>
                                                </div>
                                            </div>
                                        `
                                          )
                                          .join('')}
                                    </div>

                                    <div class="status-box status-warning">
                                        <strong>üîÑ IMPORTANT - Next Step:</strong><br><br>
                                        Go to your HomeHub Dashboard tab and press <strong>Ctrl+R</strong> (or F5) to refresh.<br><br>
                                        Your favorites should now appear in the "Favorite Devices" section!
                                    </div>

                                    <button class="btn btn-success" onclick="window.open('http://localhost:5173', '_blank')">
                                        üöÄ Open Dashboard Now
                                    </button>
                                `

                  fixBtn.style.display = 'none'
                } else {
                  statusDiv.innerHTML = `
                                    <div class="status-box status-error">
                                        <strong>‚ùå VERIFICATION FAILED!</strong><br><br>
                                        Favorites were saved but verification failed. Try refreshing Dashboard anyway.
                                    </div>
                                `
                  fixBtn.disabled = false
                  fixBtn.innerHTML = 'üîÑ Try Again'
                }
              }, 500)
            }, 500)
          }, 500)
        }, 500)
      }

      // Auto-run on load
      window.addEventListener('load', () => {
        // Show initial instructions
        const statusDiv = document.getElementById('status')
        statusDiv.innerHTML = `
                <div class="status-box status-info">
                    <strong>Ready to fix favorites!</strong><br><br>
                    Click the button below to automatically configure 5 favorite devices.
                </div>
            `
      })
    </script>
  </body>
</html>
