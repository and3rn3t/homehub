<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Storage Monitor - HomeHub</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #1a202c;
        padding: 20px;
        color: white;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      h1 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .subtitle {
        color: #a0aec0;
        margin-bottom: 24px;
      }

      .panel {
        background: #2d3748;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        border: 2px solid #4a5568;
      }

      .panel h2 {
        font-size: 18px;
        margin-bottom: 16px;
        color: #68d391;
      }

      .code-block {
        background: #1a202c;
        padding: 16px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-all;
        border: 1px solid #4a5568;
      }

      .stat {
        display: inline-block;
        padding: 8px 16px;
        background: #4a5568;
        border-radius: 8px;
        margin-right: 12px;
        margin-bottom: 12px;
      }

      .stat-label {
        color: #a0aec0;
        font-size: 12px;
        text-transform: uppercase;
      }

      .stat-value {
        color: white;
        font-size: 24px;
        font-weight: 700;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        margin-right: 8px;
        margin-bottom: 8px;
      }

      .btn-primary {
        background: #4299e1;
        color: white;
      }

      .btn-primary:hover {
        background: #3182ce;
      }

      .btn-success {
        background: #48bb78;
        color: white;
      }

      .btn-danger {
        background: #f56565;
        color: white;
      }

      .alert {
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        border-left: 4px solid;
      }

      .alert-error {
        background: #742a2a;
        border-color: #f56565;
      }

      .alert-success {
        background: #22543d;
        border-color: #48bb78;
      }

      .alert-warning {
        background: #744210;
        border-color: #f6e05e;
      }

      .device-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 12px;
        margin-top: 16px;
      }

      .device-card {
        background: #1a202c;
        border: 2px solid #4a5568;
        border-radius: 8px;
        padding: 12px;
      }

      .device-card.favorite {
        border-color: #f6e05e;
        background: #3d3d1a;
      }

      .device-name {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .device-id {
        font-size: 11px;
        color: #a0aec0;
        font-family: 'Courier New', monospace;
      }

      .refresh-timer {
        color: #68d391;
        font-size: 12px;
        margin-bottom: 16px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üî¥ Live Storage Monitor</h1>
      <p class="subtitle">Real-time view of localStorage (updates every 2 seconds)</p>

      <div class="refresh-timer" id="timer">Next refresh in: 2s</div>

      <div style="margin-bottom: 20px">
        <button class="btn btn-primary" onclick="forceRefresh()">üîÑ Refresh Now</button>
        <button class="btn btn-success" onclick="testWrite()">‚úèÔ∏è Test Write</button>
        <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear All Data</button>
      </div>

      <div id="content"></div>
    </div>

    <script>
      let countdown = 2
      let intervalId

      function forceRefresh() {
        countdown = 2
        updateDisplay()
      }

      function testWrite() {
        const testFavorites = ['hue-39', 'hue-55', 'hue-45', 'hue-47', 'hue-42']
        localStorage.setItem('kv:favorite-devices', JSON.stringify(testFavorites))
        localStorage.setItem('favorite-devices', JSON.stringify(testFavorites))
        alert('‚úÖ Test write complete! Check if favorites appear now.')
        forceRefresh()
      }

      function clearAll() {
        if (!confirm('‚ö†Ô∏è This will clear ALL localStorage data. Continue?')) return
        localStorage.clear()
        alert('‚úÖ All data cleared!')
        forceRefresh()
      }

      function updateDisplay() {
        const content = document.getElementById('content')
        let html = ''

        // Get all localStorage data
        const allKeys = Object.keys(localStorage)
        const relevantKeys = allKeys.filter(
          k => k.includes('device') || k.includes('favorite') || k.includes('kv:')
        )

        // Stats
        html += `
                <div class="panel">
                    <h2>üìä Statistics</h2>
                    <div class="stat">
                        <div class="stat-label">Total Keys</div>
                        <div class="stat-value">${allKeys.length}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Relevant Keys</div>
                        <div class="stat-value">${relevantKeys.length}</div>
                    </div>
                </div>
            `

        // Parse devices
        let devices = []
        let devicesSource = 'none'
        const kvDevices = localStorage.getItem('kv:devices')
        const legacyDevices = localStorage.getItem('devices')

        if (kvDevices) {
          try {
            devices = JSON.parse(kvDevices)
            devicesSource = 'kv:devices'
          } catch (e) {
            console.error('Parse error:', e)
          }
        } else if (legacyDevices) {
          try {
            devices = JSON.parse(legacyDevices)
            devicesSource = 'devices'
          } catch (e) {
            console.error('Parse error:', e)
          }
        }

        // Parse favorites
        let favorites = []
        let favoritesSource = 'none'
        const kvFavorites = localStorage.getItem('kv:favorite-devices')
        const legacyFavorites = localStorage.getItem('favorite-devices')

        if (kvFavorites) {
          try {
            favorites = JSON.parse(kvFavorites)
            favoritesSource = 'kv:favorite-devices'
          } catch (e) {
            console.error('Parse error:', e)
          }
        } else if (legacyFavorites) {
          try {
            favorites = JSON.parse(legacyFavorites)
            favoritesSource = 'favorite-devices'
          } catch (e) {
            console.error('Parse error:', e)
          }
        }

        // Devices panel
        html += `
                <div class="panel">
                    <h2>üì¶ Devices Storage</h2>
                    ${
                      devices.length === 0
                        ? `
                        <div class="alert alert-error">
                            ‚ùå No devices found in localStorage!
                        </div>
                    `
                        : `
                        <div class="stat">
                            <div class="stat-label">Source</div>
                            <div class="stat-value">${devicesSource}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Count</div>
                            <div class="stat-value">${devices.length}</div>
                        </div>
                        <div class="code-block">${kvDevices ? kvDevices.substring(0, 500) : legacyDevices.substring(0, 500)}...</div>
                    `
                    }
                </div>
            `

        // Favorites panel
        html += `
                <div class="panel">
                    <h2>‚≠ê Favorites Storage</h2>
                    ${
                      favorites.length === 0
                        ? `
                        <div class="alert alert-error">
                            ‚ùå No favorites configured!
                            <br><br>
                            <button class="btn btn-success" onclick="testWrite()">‚ú® Add Test Favorites</button>
                        </div>
                    `
                        : `
                        <div class="stat">
                            <div class="stat-label">Source</div>
                            <div class="stat-value">${favoritesSource}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Count</div>
                            <div class="stat-value">${favorites.length}</div>
                        </div>
                        <div class="code-block">${JSON.stringify(favorites, null, 2)}</div>
                    `
                    }
                </div>
            `

        // Matching analysis
        if (devices.length > 0 && favorites.length > 0) {
          const matchedDevices = devices.filter(d => favorites.includes(d.id))
          const unmatchedFavorites = favorites.filter(fav => !devices.find(d => d.id === fav))

          html += `
                    <div class="panel">
                        <h2>üéØ Matching Analysis</h2>
                        <div class="stat">
                            <div class="stat-label">Matched</div>
                            <div class="stat-value">${matchedDevices.length}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Unmatched</div>
                            <div class="stat-value">${unmatchedFavorites.length}</div>
                        </div>

                        ${
                          unmatchedFavorites.length > 0
                            ? `
                            <div class="alert alert-warning">
                                ‚ö†Ô∏è ${unmatchedFavorites.length} favorite IDs don't match any devices:<br>
                                <code>${unmatchedFavorites.join(', ')}</code>
                            </div>
                        `
                            : ''
                        }

                        ${
                          matchedDevices.length > 0
                            ? `
                            <div class="alert alert-success">
                                ‚úÖ ${matchedDevices.length} favorites match devices correctly!
                            </div>
                            <div class="device-grid">
                                ${matchedDevices
                                  .map(
                                    d => `
                                    <div class="device-card favorite">
                                        <div class="device-name">‚≠ê ${d.name}</div>
                                        <div class="device-id">${d.id}</div>
                                    </div>
                                `
                                  )
                                  .join('')}
                            </div>
                        `
                            : ''
                        }
                    </div>
                `
        }

        // All localStorage keys
        html += `
                <div class="panel">
                    <h2>üîë All localStorage Keys</h2>
                    <div class="code-block">${allKeys.join('\n')}</div>
                </div>
            `

        // Diagnosis
        let diagnosis = ''
        if (devices.length === 0) {
          diagnosis = `
                    <div class="alert alert-error">
                        <strong>‚ùå ROOT CAUSE: No devices in storage</strong><br><br>
                        Run reimport-hue-devices.html to import devices first.
                    </div>
                `
        } else if (favorites.length === 0) {
          diagnosis = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è ROOT CAUSE: No favorites configured</strong><br><br>
                        Click "Add Test Favorites" button above to populate favorites.
                    </div>
                `
        } else if (devices.filter(d => favorites.includes(d.id)).length === 0) {
          diagnosis = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è ROOT CAUSE: Favorite IDs don't match device IDs</strong><br><br>
                        Favorites: ${favorites.join(', ')}<br>
                        Device IDs: ${devices
                          .slice(0, 5)
                          .map(d => d.id)
                          .join(', ')}...<br><br>
                        Click "Add Test Favorites" to fix.
                    </div>
                `
        } else {
          diagnosis = `
                    <div class="alert alert-success">
                        <strong>‚úÖ STORAGE IS CORRECT!</strong><br><br>
                        ${devices.filter(d => favorites.includes(d.id)).length} favorites match devices.<br><br>
                        If Dashboard still doesn't show them:<br>
                        1. Hard refresh Dashboard (Ctrl+Shift+R)<br>
                        2. Check browser console for errors (F12)<br>
                        3. Verify useKV hook is reading from localStorage
                    </div>
                `
        }

        html += `
                <div class="panel">
                    <h2>üîç Diagnosis</h2>
                    ${diagnosis}
                </div>
            `

        content.innerHTML = html
      }

      function updateTimer() {
        countdown--
        document.getElementById('timer').textContent = `Next refresh in: ${countdown}s`

        if (countdown <= 0) {
          updateDisplay()
          countdown = 2
        }
      }

      // Initial load
      updateDisplay()

      // Auto-refresh every 2 seconds
      intervalId = setInterval(updateTimer, 1000)
    </script>
  </body>
</html>
