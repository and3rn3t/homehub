<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Re-Import Hue Devices</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        text-align: center;
      }
      .section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .button {
        background: #667eea;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
        font-weight: bold;
      }
      .button:hover {
        background: #5568d3;
        transform: translateY(-1px);
      }
      .button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
      }
      .status {
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }
      .status.success {
        background: #d1fae5;
        border-left: 4px solid #10b981;
        color: #065f46;
      }
      .status.error {
        background: #fee2e2;
        border-left: 4px solid #ef4444;
        color: #991b1b;
      }
      .status.info {
        background: #dbeafe;
        border-left: 4px solid #3b82f6;
        color: #1e40af;
      }
      .status.warning {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        color: #92400e;
      }
      .progress {
        background: #e5e7eb;
        border-radius: 8px;
        height: 30px;
        overflow: hidden;
        margin: 15px 0;
      }
      .progress-bar {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        height: 100%;
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }
      .device-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        margin: 15px 0;
      }
      .device-card {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px;
        font-size: 0.875rem;
      }
      .device-card.extended-color {
        border-left: 4px solid #10b981;
      }
      .device-card.dimmable {
        border-left: 4px solid #f59e0b;
      }
      .device-name {
        font-weight: bold;
        margin-bottom: 5px;
      }
      .device-id {
        color: #6b7280;
        font-family: monospace;
        font-size: 0.75rem;
      }
      pre {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 8px;
        overflow-x: auto;
        font-size: 0.875rem;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>🔄 Re-Import Hue Devices</h1>
      <p>Fetch all devices from Hue Bridge and save to localStorage</p>
    </div>

    <div class="section">
      <h3>Step 1: Import Devices from Hue Bridge</h3>
      <p>This will fetch all 22+ devices from your Hue Bridge at <strong>192.168.1.6</strong></p>
      <button id="importBtn" class="button" onclick="importDevices()">
        🚀 Import Devices from Hue Bridge
      </button>
    </div>

    <div id="progressSection" style="display: none" class="section">
      <h3>Progress</h3>
      <div class="progress">
        <div id="progressBar" class="progress-bar" style="width: 0%">0%</div>
      </div>
      <div id="progressText"></div>
    </div>

    <div id="statusSection"></div>

    <div id="devicesSection" style="display: none" class="section">
      <h3>Imported Devices</h3>
      <div id="deviceList"></div>
    </div>

    <div id="nextSteps" style="display: none" class="section">
      <h3>✅ Next Steps</h3>
      <div class="status success">
        <p><strong>Devices successfully imported!</strong></p>
        <ol>
          <li>Devices are now in localStorage at key: <code>kv:devices</code></li>
          <li>5 Extended Color devices added to favorites</li>
          <li>Refresh your HomeHub Dashboard to see them</li>
        </ol>
      </div>
      <button class="button" onclick="window.open('http://localhost:5173', '_blank')">
        🚀 Open HomeHub Dashboard
      </button>
    </div>

    <script>
      const BRIDGE_IP = '192.168.1.6'
      const API_KEY = 'xddEM82d6i8rZDvEy0jAdXL3rA8vxmnxTSUBIhyA'

      function showStatus(message, type = 'info') {
        const statusSection = document.getElementById('statusSection')
        statusSection.innerHTML = `<div class="section"><div class="status ${type}">${message}</div></div>`
      }

      function updateProgress(percent, text) {
        document.getElementById('progressSection').style.display = 'block'
        document.getElementById('progressBar').style.width = percent + '%'
        document.getElementById('progressBar').textContent = percent + '%'
        document.getElementById('progressText').innerHTML = `<div class="status info">${text}</div>`
      }

      async function importDevices() {
        const btn = document.getElementById('importBtn')
        btn.disabled = true
        btn.textContent = '⏳ Importing...'

        try {
          updateProgress(10, 'Connecting to Hue Bridge at 192.168.1.6...')

          // Fetch all lights from Hue Bridge
          const response = await fetch(`http://${BRIDGE_IP}/api/${API_KEY}/lights`)

          if (!response.ok) {
            throw new Error(`Bridge returned ${response.status}: ${response.statusText}`)
          }

          updateProgress(40, 'Parsing device data from bridge...')
          const lights = await response.json()

          // Convert Hue lights to HomeHub Device format
          const devices = []
          let processedCount = 0
          const totalLights = Object.keys(lights).length

          for (const [lightId, light] of Object.entries(lights)) {
            processedCount++
            updateProgress(
              40 + (processedCount / totalLights) * 40,
              `Processing device ${processedCount}/${totalLights}: ${light.name}`
            )

            // Determine capabilities
            const capabilities = []
            if (light.state.bri !== undefined) capabilities.push('dimming')
            if (light.state.xy !== undefined || light.state.hue !== undefined)
              capabilities.push('color')
            if (light.state.ct !== undefined) capabilities.push('color-temp')

            // Extract room from name or default to 'Unassigned'
            let room = 'Unassigned'
            const nameParts = light.name.split(' - ')
            if (nameParts.length > 1) {
              room = nameParts[0]
            } else {
              // Try to guess room from name
              const commonRooms = [
                'Living Room',
                'Bedroom',
                'Kitchen',
                'Bathroom',
                'Dining Room',
                'Office',
                'Garage',
                'Entryway',
                'Family Room',
                'Master Bedroom',
              ]
              for (const r of commonRooms) {
                if (light.name.includes(r)) {
                  room = r
                  break
                }
              }
            }

            const device = {
              id: `hue-${lightId}`,
              name: light.name,
              type: 'light',
              room: room,
              protocol: 'hue',
              status: light.state.reachable ? 'online' : 'offline',
              enabled: light.state.on,
              value: light.state.bri ? Math.round((light.state.bri / 254) * 100) : undefined,
              unit: light.state.bri ? '%' : undefined,
              capabilities: capabilities,
              metadata: {
                bridgeId: lightId,
                modelId: light.modelid,
                manufacturer: light.manufacturername,
                firmwareVersion: light.swversion,
              },
            }

            devices.push(device)
          }

          updateProgress(90, `Saving ${devices.length} devices to localStorage...`)

          // Save to localStorage
          localStorage.setItem('kv:devices', JSON.stringify(devices))

          // Also save to 'devices' key for compatibility
          localStorage.setItem('devices', JSON.stringify(devices))

          updateProgress(95, 'Setting up favorites...')

          // Auto-add 5 Extended Color devices to favorites
          const extendedColorDevices = devices
            .filter(
              d =>
                d.capabilities.includes('color') &&
                d.capabilities.includes('dimming') &&
                d.capabilities.includes('color-temp') &&
                d.status === 'online'
            )
            .slice(0, 5)

          const favoriteIds = extendedColorDevices.map(d => d.id)
          localStorage.setItem('favorite-devices', JSON.stringify(favoriteIds))
          localStorage.setItem('kv:favorite-devices', JSON.stringify(favoriteIds))

          updateProgress(100, '✅ Complete!')

          // Show success
          showStatus(
            `
          <h4>✅ Successfully imported ${devices.length} devices!</h4>
          <ul>
            <li><strong>Total devices:</strong> ${devices.length}</li>
            <li><strong>Extended Color:</strong> ${devices.filter(d => d.capabilities.includes('color')).length}</li>
            <li><strong>Dimmable:</strong> ${devices.filter(d => d.capabilities.includes('dimming') && !d.capabilities.includes('color')).length}</li>
            <li><strong>Online:</strong> ${devices.filter(d => d.status === 'online').length}</li>
            <li><strong>Auto-favorited:</strong> ${favoriteIds.length}</li>
          </ul>
          <p><strong>Favorite devices:</strong></p>
          <ul>
            ${extendedColorDevices.map(d => `<li>${d.name} (${d.id})</li>`).join('')}
          </ul>
        `,
            'success'
          )

          // Show device grid
          document.getElementById('devicesSection').style.display = 'block'
          const deviceGrid = devices
            .map(d => {
              const cardClass = d.capabilities.includes('color') ? 'extended-color' : 'dimmable'
              return `
            <div class="device-card ${cardClass}">
              <div class="device-name">${d.name}</div>
              <div class="device-id">${d.id}</div>
              <div style="margin-top: 5px; font-size: 0.75rem; color: #6b7280;">
                ${d.room} • ${d.status}
              </div>
            </div>
          `
            })
            .join('')
          document.getElementById('deviceList').innerHTML =
            `<div class="device-grid">${deviceGrid}</div>`

          // Show next steps
          document.getElementById('nextSteps').style.display = 'block'

          btn.textContent = '✅ Import Complete!'
        } catch (error) {
          console.error('Import error:', error)
          showStatus(
            `
          <h4>❌ Import Failed</h4>
          <p><strong>Error:</strong> ${error.message}</p>
          <p><strong>Troubleshooting:</strong></p>
          <ul>
            <li>Verify Hue Bridge is accessible at http://192.168.1.6</li>
            <li>Check API key is correct</li>
            <li>Ensure bridge is on same network</li>
            <li>Try opening bridge in browser: <a href="http://192.168.1.6/api/${API_KEY}/lights" target="_blank">http://192.168.1.6/api/${API_KEY}/lights</a></li>
          </ul>
          <p><strong>Full error:</strong></p>
          <pre>${error.stack || error.message}</pre>
        `,
            'error'
          )
          btn.disabled = false
          btn.textContent = '🔄 Try Again'
        }
      }
    </script>
  </body>
</html>
