<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Emergency Favorites Debugger - HomeHub</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #1a202c;
        padding: 20px;
        color: white;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #f56565;
      }

      .subtitle {
        color: #a0aec0;
        margin-bottom: 24px;
        font-size: 16px;
      }

      .panel {
        background: #2d3748;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
        border: 2px solid #4a5568;
      }

      .panel h2 {
        font-size: 20px;
        margin-bottom: 16px;
        color: #68d391;
      }

      .code-block {
        background: #1a202c;
        padding: 16px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        overflow-x: auto;
        white-space: pre-wrap;
        border: 1px solid #4a5568;
        color: #68d391;
      }

      .alert {
        padding: 16px;
        border-radius: 8px;
        margin: 16px 0;
        border-left: 4px solid;
      }

      .alert-error {
        background: #742a2a;
        border-color: #f56565;
        color: #fed7d7;
      }

      .alert-success {
        background: #22543d;
        border-color: #48bb78;
        color: #c6f6d5;
      }

      .alert-warning {
        background: #744210;
        border-color: #f6e05e;
        color: #fef5e7;
      }

      .btn {
        padding: 16px 32px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s;
        margin-right: 12px;
        margin-bottom: 12px;
      }

      .btn-danger {
        background: #f56565;
        color: white;
      }

      .btn-danger:hover {
        background: #e53e3e;
      }

      .btn-success {
        background: #48bb78;
        color: white;
      }

      .btn-success:hover {
        background: #38a169;
      }

      .stat {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        background: #1a202c;
        border-radius: 8px;
        margin-bottom: 8px;
        border: 1px solid #4a5568;
      }

      .stat-label {
        color: #a0aec0;
        font-weight: 600;
      }

      .stat-value {
        color: white;
        font-family: 'Courier New', monospace;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üö® Emergency Favorites Debugger</h1>
      <p class="subtitle">Deep dive into what's preventing favorites from showing</p>

      <div id="results"></div>

      <div style="margin-top: 24px">
        <button class="btn btn-danger" onclick="nuclearOption()">
          üí£ Nuclear Option (Clear Everything & Restart)
        </button>
        <button class="btn btn-success" onclick="runDebug()">üîÑ Re-run Debug</button>
      </div>
    </div>

    <script>
      function runDebug() {
        const results = document.getElementById('results')
        let html = ''

        console.log('=== EMERGENCY DEBUG START ===')

        // Panel 1: Raw localStorage
        html += '<div class="panel"><h2>üîç Step 1: Raw localStorage Data</h2>'

        const kvDevices = localStorage.getItem('kv:devices')
        const legacyDevices = localStorage.getItem('devices')
        const kvFavorites = localStorage.getItem('kv:favorite-devices')
        const legacyFavorites = localStorage.getItem('favorite-devices')

        html +=
          '<div class="stat"><span class="stat-label">kv:devices exists</span><span class="stat-value">' +
          (kvDevices ? 'YES' : 'NO') +
          '</span></div>'
        html +=
          '<div class="stat"><span class="stat-label">devices exists</span><span class="stat-value">' +
          (legacyDevices ? 'YES' : 'NO') +
          '</span></div>'
        html +=
          '<div class="stat"><span class="stat-label">kv:favorite-devices exists</span><span class="stat-value">' +
          (kvFavorites ? 'YES' : 'NO') +
          '</span></div>'
        html +=
          '<div class="stat"><span class="stat-label">favorite-devices exists</span><span class="stat-value">' +
          (legacyFavorites ? 'YES' : 'NO') +
          '</span></div>'

        if (kvFavorites) {
          html +=
            '<h3 style="margin-top: 16px; color: #68d391;">Raw kv:favorite-devices value:</h3>'
          html += '<div class="code-block">' + kvFavorites + '</div>'
        }

        if (legacyFavorites) {
          html += '<h3 style="margin-top: 16px; color: #68d391;">Raw favorite-devices value:</h3>'
          html += '<div class="code-block">' + legacyFavorites + '</div>'
        }

        html += '</div>'

        // Panel 2: Parsed Data
        html += '<div class="panel"><h2>üì¶ Step 2: Parsed Data</h2>'

        let devices = []
        let favorites = []

        try {
          if (kvDevices) {
            devices = JSON.parse(kvDevices)
            html +=
              '<div class="alert alert-success">‚úÖ Successfully parsed devices: ' +
              devices.length +
              ' items</div>'
          } else if (legacyDevices) {
            devices = JSON.parse(legacyDevices)
            html +=
              '<div class="alert alert-success">‚úÖ Successfully parsed legacy devices: ' +
              devices.length +
              ' items</div>'
          } else {
            html += '<div class="alert alert-error">‚ùå No devices found!</div>'
          }
        } catch (e) {
          html +=
            '<div class="alert alert-error">‚ùå Failed to parse devices: ' + e.message + '</div>'
        }

        try {
          if (kvFavorites) {
            favorites = JSON.parse(kvFavorites)
            html +=
              '<div class="alert alert-success">‚úÖ Successfully parsed favorites: ' +
              favorites.length +
              ' items</div>'
            html += '<div class="code-block">' + JSON.stringify(favorites, null, 2) + '</div>'
          } else if (legacyFavorites) {
            favorites = JSON.parse(legacyFavorites)
            html +=
              '<div class="alert alert-success">‚úÖ Successfully parsed legacy favorites: ' +
              favorites.length +
              ' items</div>'
            html += '<div class="code-block">' + JSON.stringify(favorites, null, 2) + '</div>'
          } else {
            html += '<div class="alert alert-error">‚ùå No favorites found!</div>'
          }
        } catch (e) {
          html +=
            '<div class="alert alert-error">‚ùå Failed to parse favorites: ' + e.message + '</div>'
        }

        html += '</div>'

        // Panel 3: Matching Logic
        if (devices.length > 0 && favorites.length > 0) {
          html += '<div class="panel"><h2>üéØ Step 3: Matching Logic Test</h2>'

          html += '<h3 style="color: #68d391; margin-bottom: 12px;">Favorite IDs:</h3>'
          html += '<div class="code-block">' + JSON.stringify(favorites, null, 2) + '</div>'

          html += '<h3 style="color: #68d391; margin: 16px 0 12px;">Device IDs (first 10):</h3>'
          html +=
            '<div class="code-block">' +
            JSON.stringify(
              devices.slice(0, 10).map(d => d.id),
              null,
              2
            ) +
            '</div>'

          const matched = devices.filter(device => favorites.includes(device.id))

          html +=
            '<div class="stat"><span class="stat-label">Matched Devices</span><span class="stat-value">' +
            matched.length +
            ' / ' +
            favorites.length +
            '</span></div>'

          if (matched.length === 0) {
            html +=
              '<div class="alert alert-error"><strong>‚ùå PROBLEM IDENTIFIED:</strong> No favorite IDs match device IDs!</div>'

            // Check for common issues
            const deviceIdSample = devices.length > 0 ? devices[0].id : 'N/A'
            const favoriteIdSample = favorites.length > 0 ? favorites[0] : 'N/A'

            html += '<div class="alert alert-warning">'
            html += '<strong>Analysis:</strong><br>'
            html += 'Sample Device ID: <code>' + deviceIdSample + '</code><br>'
            html += 'Sample Favorite ID: <code>' + favoriteIdSample + '</code><br><br>'

            if (
              favoriteIdSample.includes('living-room') ||
              favoriteIdSample.includes('thermostat')
            ) {
              html += 'üí° Favorites still have old placeholder IDs! Click "Nuclear Option" below.'
            } else if (!deviceIdSample.startsWith('hue-')) {
              html += 'üí° Device IDs don\'t start with "hue-". Check device import.'
            } else {
              html += 'üí° Unknown mismatch. Try Nuclear Option.'
            }

            html += '</div>'
          } else {
            html +=
              '<div class="alert alert-success">‚úÖ Matching works! ' +
              matched.length +
              ' devices matched.</div>'
            html += '<h3 style="color: #68d391; margin: 16px 0 12px;">Matched Devices:</h3>'
            matched.forEach(d => {
              html +=
                '<div class="stat"><span class="stat-label">' +
                d.name +
                '</span><span class="stat-value">' +
                d.id +
                '</span></div>'
            })
          }

          html += '</div>'
        }

        // Panel 4: useKV Cache Check
        html += '<div class="panel"><h2>üíæ Step 4: Check for Cached Data Issues</h2>'

        const allKeys = Object.keys(localStorage)
        const cacheKeys = allKeys.filter(k => k.includes('cache') || k.includes('meta'))

        if (cacheKeys.length > 0) {
          html += '<div class="alert alert-warning">‚ö†Ô∏è Found cache keys that might be stale:</div>'
          cacheKeys.forEach(key => {
            html +=
              '<div class="stat"><span class="stat-label">' +
              key +
              '</span><span class="stat-value">EXISTS</span></div>'
          })
        } else {
          html += '<div class="alert alert-success">‚úÖ No cache keys found</div>'
        }

        html += '</div>'

        // Panel 5: Diagnosis
        html += '<div class="panel"><h2>üî¨ Final Diagnosis</h2>'

        if (devices.length === 0) {
          html +=
            '<div class="alert alert-error"><strong>‚ùå ROOT CAUSE:</strong> No devices in localStorage<br><br>Use reimport-hue-devices.html to import devices.</div>'
        } else if (favorites.length === 0) {
          html +=
            '<div class="alert alert-error"><strong>‚ùå ROOT CAUSE:</strong> No favorites in localStorage<br><br>Click "Nuclear Option" below to fix everything.</div>'
        } else if (devices.filter(d => favorites.includes(d.id)).length === 0) {
          html +=
            '<div class="alert alert-error"><strong>‚ùå ROOT CAUSE:</strong> Favorite IDs don\'t match device IDs<br><br>This is the problem! Click "Nuclear Option" to fix.</div>'
        } else {
          html +=
            '<div class="alert alert-success"><strong>‚úÖ STORAGE IS PERFECT!</strong><br><br>The data is correct in localStorage. The issue must be in the React app.</div>'
          html +=
            '<div class="alert alert-warning"><strong>Next Steps:</strong><br>1. Hard refresh Dashboard (Ctrl+Shift+R)<br>2. Check browser console for errors<br>3. Make sure you saved Dashboard.tsx changes</div>'
        }

        html += '</div>'

        results.innerHTML = html
      }

      function nuclearOption() {
        if (
          !confirm(
            'üö® NUCLEAR OPTION\n\nThis will:\n1. Delete ALL localStorage data\n2. Re-import devices from Hue Bridge\n3. Auto-configure 5 favorites\n\nContinue?'
          )
        ) {
          return
        }

        const results = document.getElementById('results')
        results.innerHTML =
          '<div class="panel"><h2>üí£ Nuclear Option In Progress...</h2><div class="alert alert-warning">Working...</div></div>'

        // Step 1: Clear everything
        localStorage.clear()
        console.log('‚úÖ Step 1: Cleared all localStorage')

        // Step 2: Re-import devices from Hue Bridge
        const bridgeUrl = 'http://192.168.1.6/api/xddEM82d6i8rZDvEy0jAdXL3rA8vxmnxTSUBIhyA/lights'

        fetch(bridgeUrl)
          .then(response => response.json())
          .then(lights => {
            console.log('‚úÖ Step 2: Fetched devices from Hue Bridge:', Object.keys(lights).length)

            const devices = []

            for (const [lightId, lightData] of Object.entries(lights)) {
              const capabilities = []

              if (lightData.state.bri !== undefined) capabilities.push('dimming')
              if (lightData.state.xy !== undefined || lightData.state.hue !== undefined)
                capabilities.push('color')
              if (lightData.state.ct !== undefined) capabilities.push('color-temp')

              const roomMatch = lightData.name.match(
                /^(.+?)\s+(?:Interior|Exterior|Table|Speaker|Lamp|Light|Ceiling)/i
              )
              const room = roomMatch ? roomMatch[1].trim() : 'Unknown'

              devices.push({
                id: `hue-${lightId}`,
                name: lightData.name,
                type: 'light',
                protocol: 'hue',
                room: room,
                status: lightData.state.reachable ? 'online' : 'offline',
                enabled: lightData.state.on,
                capabilities: capabilities,
                metadata: {
                  manufacturer: lightData.manufacturername,
                  modelId: lightData.modelid,
                  modelName: lightData.type,
                  firmwareVersion: lightData.swversion,
                  bridgeId: lightId,
                },
              })
            }

            // Save devices to BOTH keys
            localStorage.setItem('kv:devices', JSON.stringify(devices))
            localStorage.setItem('devices', JSON.stringify(devices))
            console.log('‚úÖ Step 3: Saved devices to localStorage:', devices.length)

            // Step 4: Create favorites from color lights
            const colorLights = devices.filter(d => d.capabilities.includes('color'))
            const favoriteDevices = colorLights.slice(0, 5).map(d => d.id)

            localStorage.setItem('kv:favorite-devices', JSON.stringify(favoriteDevices))
            localStorage.setItem('favorite-devices', JSON.stringify(favoriteDevices))
            console.log('‚úÖ Step 4: Saved favorites:', favoriteDevices)

            // Success!
            results.innerHTML = `
                        <div class="panel">
                            <h2>‚úÖ Nuclear Option Complete!</h2>
                            <div class="alert alert-success">
                                <strong>SUCCESS!</strong><br><br>
                                ‚úÖ Cleared all localStorage<br>
                                ‚úÖ Imported ${devices.length} devices from Hue Bridge<br>
                                ‚úÖ Configured ${favoriteDevices.length} favorites<br><br>
                                <strong>Favorite Devices:</strong><br>
                                ${colorLights
                                  .slice(0, 5)
                                  .map(d => '‚Ä¢ ' + d.name)
                                  .join('<br>')}
                            </div>
                            <div class="alert alert-warning">
                                <strong>üîÑ FINAL STEP:</strong><br><br>
                                1. Go to Dashboard tab<br>
                                2. Press <strong>Ctrl+Shift+R</strong> (hard refresh)<br>
                                3. Favorites should now appear!
                            </div>
                            <button class="btn btn-success" onclick="window.open('http://localhost:5173', '_blank')">
                                üöÄ Open Dashboard Now
                            </button>
                        </div>
                    `

            runDebug()
          })
          .catch(error => {
            console.error('‚ùå Failed:', error)
            results.innerHTML = `
                        <div class="panel">
                            <h2>‚ùå Nuclear Option Failed</h2>
                            <div class="alert alert-error">
                                <strong>ERROR:</strong> ${error.message}<br><br>
                                Make sure your Hue Bridge is accessible at 192.168.1.6
                            </div>
                        </div>
                    `
          })
      }

      // Auto-run on load
      window.addEventListener('load', runDebug)
    </script>
  </body>
</html>
