<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fix Storage - HomeHub</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        max-width: 800px;
        margin: 60px auto;
        padding: 40px;
        background: #0a0a0a;
        color: #fff;
        text-align: center;
      }
      h1 {
        color: #4a9eff;
        margin-bottom: 30px;
      }
      .status {
        display: inline-block;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        margin: 20px 0;
      }
      .success {
        background: #10b981;
        color: #fff;
      }
      .error {
        background: #ef4444;
        color: #fff;
      }
      .info {
        background: #3b82f6;
        color: #fff;
      }
      button {
        background: #4a9eff;
        color: #fff;
        border: none;
        padding: 16px 32px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin: 10px;
      }
      button:hover {
        background: #3b8fd9;
      }
      button.success {
        background: #10b981;
      }
      button.success:hover {
        background: #059669;
      }
      pre {
        background: #000;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        text-align: left;
        margin: 20px auto;
        max-width: 600px;
        overflow-x: auto;
      }
      .section {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 30px;
        margin: 30px 0;
      }
    </style>
  </head>
  <body>
    <h1>üîß Fix Storage Keys</h1>

    <div class="section">
      <h2 style="color: #10b981; margin-bottom: 20px">Problem Found</h2>
      <p style="font-size: 18px; line-height: 1.6; color: #ccc">
        Your 22 Hue devices are stored under the key <code>"devices"</code>,<br />
        but the Dashboard expects them under <code>"kv:devices"</code>.
      </p>
    </div>

    <div class="section">
      <h2 style="color: #4a9eff; margin-bottom: 20px">Solution</h2>
      <p style="font-size: 16px; color: #ccc; margin-bottom: 20px">
        Click the button below to copy the data to the correct key.
      </p>

      <div id="status"></div>

      <button id="fixButton" onclick="fixStorage()">üîß Fix Storage Key</button>

      <div id="details" style="margin-top: 20px"></div>
    </div>

    <div class="section" style="margin-top: 30px">
      <button onclick="window.location.href='http://localhost:5173'" class="success">
        üè† Open Dashboard
      </button>
      <button onclick="window.location.href='http://localhost:5173/check-storage.html'">
        üîç Check Storage
      </button>
    </div>

    <script>
      function checkCurrentState() {
        const oldKey = localStorage.getItem('devices')
        const newKey = localStorage.getItem('kv:devices')

        const statusDiv = document.getElementById('status')
        const detailsDiv = document.getElementById('details')

        if (!oldKey) {
          statusDiv.innerHTML = '<div class="status error">‚ùå No data found at "devices" key</div>'
          detailsDiv.innerHTML =
            '<p style="color: #f59e0b;">You may need to re-import your devices.</p>'
          document.getElementById('fixButton').disabled = true
          return false
        }

        try {
          const devices = JSON.parse(oldKey)
          const hueDevices = Array.isArray(devices) ? devices.filter(d => d.protocol === 'hue') : []

          if (newKey) {
            const newDevices = JSON.parse(newKey)
            statusDiv.innerHTML = `
            <div class="status success">‚úÖ Already Fixed!</div>
            <p style="margin-top: 15px; color: #10b981;">
              Found ${newDevices.length} devices at "kv:devices"
            </p>
          `
            document.getElementById('fixButton').textContent = '‚úÖ Already Fixed'
            document.getElementById('fixButton').disabled = true
            return true
          }

          statusDiv.innerHTML = `
          <div class="status info">üì¶ Ready to fix</div>
          <p style="margin-top: 15px; color: #ccc;">
            Found ${devices.length} devices at "devices"<br>
            (${hueDevices.length} Hue devices)
          </p>
        `
          return false
        } catch (error) {
          statusDiv.innerHTML = '<div class="status error">‚ùå Data is corrupted</div>'
          detailsDiv.innerHTML = `<pre style="color: #ef4444;">${error.message}</pre>`
          document.getElementById('fixButton').disabled = true
          return false
        }
      }

      function fixStorage() {
        const detailsDiv = document.getElementById('details')
        const statusDiv = document.getElementById('status')

        try {
          // Get data from old key
          const oldData = localStorage.getItem('devices')
          if (!oldData) {
            throw new Error('No data found at "devices" key')
          }

          // Validate it's valid JSON
          const devices = JSON.parse(oldData)
          if (!Array.isArray(devices)) {
            throw new Error('Data is not an array')
          }

          // Copy to new key
          localStorage.setItem('kv:devices', oldData)

          // Verify
          const verification = localStorage.getItem('kv:devices')
          if (verification === oldData) {
            const hueDevices = devices.filter(d => d.protocol === 'hue')

            statusDiv.innerHTML = `
            <div class="status success">‚úÖ Fixed Successfully!</div>
            <p style="margin-top: 15px; color: #10b981;">
              Copied ${devices.length} devices to "kv:devices"<br>
              (${hueDevices.length} Hue devices)
            </p>
          `

            detailsDiv.innerHTML = `
            <p style="margin-top: 20px; font-size: 18px; color: #10b981;">
              ‚úÖ Dashboard should now show your devices!
            </p>
            <p style="margin-top: 10px; color: #ccc;">
              Click "Open Dashboard" above and refresh the page (Ctrl+Shift+R)
            </p>
          `

            document.getElementById('fixButton').textContent = '‚úÖ Fixed'
            document.getElementById('fixButton').disabled = true
            document.getElementById('fixButton').classList.add('success')
          } else {
            throw new Error('Verification failed - data not copied correctly')
          }
        } catch (error) {
          statusDiv.innerHTML = '<div class="status error">‚ùå Fix Failed</div>'
          detailsDiv.innerHTML = `<pre style="color: #ef4444;">${error.message}</pre>`
        }
      }

      // Check state on load
      checkCurrentState()
    </script>
  </body>
</html>
