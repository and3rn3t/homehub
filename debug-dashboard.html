<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Debug - HomeHub</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
        background: #0a0a0a;
        color: #fff;
      }
      h1 {
        color: #4a9eff;
        margin-bottom: 30px;
      }
      h2 {
        color: #10b981;
        margin-top: 30px;
      }
      .section {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        margin-left: 10px;
      }
      .success {
        background: #10b981;
        color: #fff;
      }
      .error {
        background: #ef4444;
        color: #fff;
      }
      .warning {
        background: #f59e0b;
        color: #fff;
      }
      .info {
        background: #3b82f6;
        color: #fff;
      }
      pre {
        background: #000;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
        overflow-x: auto;
        font-size: 13px;
        line-height: 1.5;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }
      .stat-card {
        background: #000;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
      }
      .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #4a9eff;
        margin: 10px 0;
      }
      .stat-label {
        font-size: 14px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      button {
        background: #4a9eff;
        color: #fff;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        margin-right: 10px;
        margin-top: 10px;
      }
      button:hover {
        background: #3b8fd9;
      }
      button.secondary {
        background: #333;
        color: #fff;
      }
      button.secondary:hover {
        background: #444;
      }
      .device-list {
        display: grid;
        gap: 10px;
        margin-top: 15px;
      }
      .device-item {
        background: #000;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .device-name {
        font-weight: 600;
      }
      .device-meta {
        font-size: 12px;
        color: #888;
        margin-top: 4px;
      }
      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        margin-left: 8px;
      }
      .badge-hue {
        background: #f97316;
        color: #fff;
      }
      .badge-mqtt {
        background: #10b981;
        color: #fff;
      }
      .badge-http {
        background: #3b82f6;
        color: #fff;
      }
      .badge-online {
        background: #10b981;
        color: #fff;
      }
      .badge-offline {
        background: #ef4444;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <h1>üîç Dashboard Debug Tool</h1>

    <div class="section">
      <h2>1. LocalStorage Check</h2>
      <div id="localStorage-status"></div>
      <div class="stats" id="localStorage-stats"></div>
      <div id="localStorage-data"></div>
    </div>

    <div class="section">
      <h2>2. Worker KV Check</h2>
      <div id="worker-status"></div>
      <div class="stats" id="worker-stats"></div>
      <div id="worker-data"></div>
    </div>

    <div class="section">
      <h2>3. useKV Hook Simulation</h2>
      <div id="hook-simulation"></div>
      <pre id="hook-logic"></pre>
    </div>

    <div class="section">
      <h2>4. Actions</h2>
      <button onclick="checkAll()">üîÑ Refresh All Checks</button>
      <button onclick="clearLocalStorage()" class="secondary">üóëÔ∏è Clear LocalStorage</button>
      <button onclick="testWorkerSync()" class="secondary">üì§ Test Worker Sync</button>
      <button onclick="window.location.href='http://localhost:5173'">üè† Open Dashboard</button>
    </div>

    <script>
      async function checkLocalStorage() {
        const statusDiv = document.getElementById('localStorage-status')
        const statsDiv = document.getElementById('localStorage-stats')
        const dataDiv = document.getElementById('localStorage-data')

        try {
          const devicesJson = localStorage.getItem('devices')

          if (!devicesJson) {
            statusDiv.innerHTML = '<span class="status error">‚ùå No devices in localStorage</span>'
            statsDiv.innerHTML = ''
            dataDiv.innerHTML =
              '<p style="color: #ef4444;">localStorage is empty! This is why Dashboard shows no devices.</p>'
            return null
          }

          const devices = JSON.parse(devicesJson)
          const hueDevices = devices.filter(d => d.protocol === 'hue')
          const onlineDevices = devices.filter(d => d.status === 'online')
          const enabledDevices = devices.filter(d => d.enabled)

          statusDiv.innerHTML = `<span class="status success">‚úÖ Found ${devices.length} devices in localStorage</span>`

          statsDiv.innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Total Devices</div>
            <div class="stat-value">${devices.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Hue Devices</div>
            <div class="stat-value">${hueDevices.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Online</div>
            <div class="stat-value">${onlineDevices.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Enabled</div>
            <div class="stat-value">${enabledDevices.length}</div>
          </div>
        `

          const deviceListHtml = devices
            .slice(0, 10)
            .map(
              d => `
          <div class="device-item">
            <div>
              <div class="device-name">
                ${d.name}
                <span class="badge badge-${d.protocol}">${d.protocol?.toUpperCase() || 'UNKNOWN'}</span>
                <span class="badge badge-${d.status === 'online' ? 'online' : 'offline'}">${d.status?.toUpperCase() || 'UNKNOWN'}</span>
              </div>
              <div class="device-meta">
                ID: ${d.id} | Room: ${d.room} | Type: ${d.type} | ${d.enabled ? 'ON' : 'OFF'}
              </div>
            </div>
          </div>
        `
            )
            .join('')

          dataDiv.innerHTML = `
          <h3>First 10 Devices:</h3>
          <div class="device-list">${deviceListHtml}</div>
          ${devices.length > 10 ? `<p style="color: #888; margin-top: 10px;">...and ${devices.length - 10} more</p>` : ''}
        `

          return devices
        } catch (error) {
          statusDiv.innerHTML = `<span class="status error">‚ùå Error reading localStorage</span>`
          dataDiv.innerHTML = `<pre style="color: #ef4444;">${error.message}</pre>`
          return null
        }
      }

      async function checkWorker() {
        const statusDiv = document.getElementById('worker-status')
        const statsDiv = document.getElementById('worker-stats')
        const dataDiv = document.getElementById('worker-data')

        statusDiv.innerHTML = '<span class="status info">‚è≥ Checking worker...</span>'

        try {
          const response = await fetch('http://127.0.0.1:8787/kv/devices')

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }

          const devices = await response.json()
          const hueDevices = devices.filter(d => d.protocol === 'hue')
          const onlineDevices = devices.filter(d => d.status === 'online')

          statusDiv.innerHTML = `<span class="status success">‚úÖ Worker responding with ${devices.length} devices</span>`

          statsDiv.innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Total Devices</div>
            <div class="stat-value">${devices.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Hue Devices</div>
            <div class="stat-value">${hueDevices.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Online</div>
            <div class="stat-value">${onlineDevices.length}</div>
          </div>
        `

          const deviceListHtml = devices
            .slice(0, 5)
            .map(
              d => `
          <div class="device-item">
            <div>
              <div class="device-name">
                ${d.name}
                <span class="badge badge-${d.protocol}">${d.protocol?.toUpperCase() || 'UNKNOWN'}</span>
              </div>
              <div class="device-meta">ID: ${d.id} | Room: ${d.room}</div>
            </div>
          </div>
        `
            )
            .join('')

          dataDiv.innerHTML = `
          <h3>First 5 Devices from Worker:</h3>
          <div class="device-list">${deviceListHtml}</div>
        `

          return devices
        } catch (error) {
          statusDiv.innerHTML = `<span class="status warning">‚ö†Ô∏è Worker not responding</span>`
          dataDiv.innerHTML = `<pre style="color: #f59e0b;">${error.message}\n\nThis is OK if Dashboard is using localStorage.</pre>`
          return null
        }
      }

      async function simulateUseKVHook() {
        const hookDiv = document.getElementById('hook-simulation')
        const logicDiv = document.getElementById('hook-logic')

        const localDevices = await checkLocalStorageQuiet()
        const workerDevices = await checkWorkerQuiet()

        const logic = [
          'üìö useKV Hook Logic:',
          '',
          '1. Check Worker KV first:',
          workerDevices
            ? `   ‚úÖ Found ${workerDevices.length} devices from worker`
            : '   ‚ùå Worker not available',
          '',
          '2. Fall back to localStorage:',
          localDevices
            ? `   ‚úÖ Found ${localDevices.length} devices in localStorage`
            : '   ‚ùå No devices in localStorage',
          '',
          '3. Use default value if both fail:',
          '   üìù Default: [] (empty array)',
          '',
          'üéØ Result:',
          workerDevices
            ? `   Using WORKER devices (${workerDevices.length} devices)`
            : localDevices
              ? `   Using LOCALSTORAGE devices (${localDevices.length} devices)`
              : '   Using DEFAULT (empty array)',
        ].join('\n')

        logicDiv.textContent = logic

        const finalCount = workerDevices?.length || localDevices?.length || 0

        if (finalCount === 0) {
          hookDiv.innerHTML = `
          <span class="status error">‚ùå Dashboard will show 0 devices</span>
          <p style="margin-top: 15px; color: #ef4444;">
            <strong>Problem:</strong> Both worker KV and localStorage are empty!<br>
            <strong>Solution:</strong> You need to re-import your Hue devices.
          </p>
        `
        } else if (workerDevices) {
          hookDiv.innerHTML = `<span class="status success">‚úÖ Dashboard will show ${finalCount} devices from Worker KV</span>`
        } else {
          hookDiv.innerHTML = `<span class="status warning">‚ö†Ô∏è Dashboard will show ${finalCount} devices from localStorage (Worker offline)</span>`
        }
      }

      async function checkLocalStorageQuiet() {
        try {
          const devicesJson = localStorage.getItem('devices')
          return devicesJson ? JSON.parse(devicesJson) : null
        } catch {
          return null
        }
      }

      async function checkWorkerQuiet() {
        try {
          const response = await fetch('http://127.0.0.1:8787/kv/devices')
          return response.ok ? await response.json() : null
        } catch {
          return null
        }
      }

      async function checkAll() {
        await checkLocalStorage()
        await checkWorker()
        await simulateUseKVHook()
      }

      function clearLocalStorage() {
        if (confirm('Are you sure? This will delete all devices from localStorage.')) {
          localStorage.removeItem('devices')
          alert('LocalStorage cleared! Click Refresh to see updated status.')
          checkAll()
        }
      }

      async function testWorkerSync() {
        const devices = await checkLocalStorageQuiet()
        if (!devices || devices.length === 0) {
          alert('No devices in localStorage to sync!')
          return
        }

        try {
          const response = await fetch('http://127.0.0.1:8787/kv/devices', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(devices),
          })

          if (response.ok) {
            alert(`‚úÖ Successfully synced ${devices.length} devices to Worker KV!`)
            checkAll()
          } else {
            alert(`‚ùå Sync failed: ${response.status} ${response.statusText}`)
          }
        } catch (error) {
          alert(`‚ùå Sync failed: ${error.message}`)
        }
      }

      // Run checks on load
      checkAll()
    </script>
  </body>
</html>
