<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug localStorage - HomeHub</title>
    <style>
      body {
        font-family: 'Courier New', monospace;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #1e1e1e;
        color: #d4d4d4;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
      }
      .section {
        background: #252526;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #3e3e42;
      }
      pre {
        background: #1e1e1e;
        padding: 15px;
        border-radius: 8px;
        overflow-x: auto;
        border: 1px solid #3e3e42;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .key-info {
        background: #0e639c;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        display: inline-block;
        margin: 5px;
        font-weight: bold;
      }
      .warning {
        background: #f59e0b;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }
      .error {
        background: #ef4444;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }
      .success {
        background: #10b981;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }
      .button {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        margin: 5px;
        transition: all 0.2s;
      }
      .button:hover {
        background: #5568d3;
        transform: translateY(-1px);
      }
      .device-count {
        font-size: 2rem;
        font-weight: bold;
        color: #10b981;
        margin: 10px 0;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #3e3e42;
      }
      th {
        background: #0e639c;
        color: white;
        font-weight: bold;
      }
      tr:hover {
        background: #2d2d30;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üîç localStorage Debug Tool</h1>
      <p>Inspect all localStorage keys and diagnose device issues</p>
    </div>

    <div class="section">
      <h3>üìä localStorage Summary</h3>
      <div id="summary"></div>
    </div>

    <div class="section">
      <h3>üîë All localStorage Keys</h3>
      <div id="allKeys"></div>
    </div>

    <div class="section">
      <h3>üì± Device Data Analysis</h3>
      <div id="deviceAnalysis"></div>
    </div>

    <div class="section">
      <h3>‚≠ê Favorites Data</h3>
      <div id="favoritesData"></div>
    </div>

    <div class="section">
      <h3>üõ†Ô∏è Quick Actions</h3>
      <button class="button" onclick="addDefaultFavorites()">‚ú® Add 5 Default Favorites</button>
      <button class="button" onclick="copyToConsole()">üìã Copy All Data to Console</button>
      <button class="button" onclick="location.reload()">üîÑ Refresh</button>
    </div>

    <script>
      function analyzeLoc alStorage() {
        const summary = document.getElementById('summary');
        const allKeys = document.getElementById('allKeys');
        const deviceAnalysis = document.getElementById('deviceAnalysis');
        const favoritesData = document.getElementById('favoritesData');

        // Get all keys
        const keys = Object.keys(localStorage);

        summary.innerHTML = `
          <div class="success">
            <strong>Total localStorage keys:</strong> ${keys.length}
          </div>
          <div style="margin-top: 15px;">
            ${keys.map(key => `<span class="key-info">${key}</span>`).join('')}
          </div>
        `;

        // Show all keys with data size
        const keysTable = keys.map(key => {
          const value = localStorage.getItem(key);
          const size = new Blob([value]).size;
          const sizeKb = (size / 1024).toFixed(2);
          return `
            <tr>
              <td><strong>${key}</strong></td>
              <td>${sizeKb} KB</td>
              <td>${value.length} chars</td>
            </tr>
          `;
        }).join('');

        allKeys.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Key</th>
                <th>Size</th>
                <th>Length</th>
              </tr>
            </thead>
            <tbody>
              ${keysTable}
            </tbody>
          </table>
        `;

        // Analyze device data
        let deviceHtml = '';
        let devicesFound = false;

        // Check all possible device keys
        const possibleKeys = ['devices', 'kv:devices', 'DEVICES', 'Device'];

        for (const key of possibleKeys) {
          const devicesJson = localStorage.getItem(key);
          if (devicesJson) {
            try {
              const devices = JSON.parse(devicesJson);
              if (Array.isArray(devices) && devices.length > 0) {
                devicesFound = true;

                const hueDevices = devices.filter(d => d.protocol === 'hue');
                const onlineDevices = devices.filter(d => d.status === 'online');
                const extendedColor = hueDevices.filter(d =>
                  d.capabilities?.includes('color') &&
                  d.capabilities?.includes('dimming') &&
                  d.capabilities?.includes('color-temp')
                );

                deviceHtml += `
                  <div class="success">
                    <h4>‚úÖ Found devices at key: "${key}"</h4>
                    <div class="device-count">${devices.length} Total Devices</div>
                    <ul>
                      <li><strong>Hue Devices:</strong> ${hueDevices.length}</li>
                      <li><strong>Online:</strong> ${onlineDevices.length}</li>
                      <li><strong>Extended Color:</strong> ${extendedColor.length}</li>
                    </ul>
                  </div>

                  <h4 style="margin-top: 20px;">üìã Device List:</h4>
                  <table>
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>ID</th>
                        <th>Protocol</th>
                        <th>Status</th>
                        <th>Capabilities</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${devices.map(d => `
                        <tr>
                          <td><strong>${d.name}</strong></td>
                          <td><code>${d.id}</code></td>
                          <td>${d.protocol || 'N/A'}</td>
                          <td>${d.status || 'N/A'}</td>
                          <td>${d.capabilities?.join(', ') || 'None'}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                `;
              }
            } catch (err) {
              deviceHtml += `
                <div class="warning">
                  Key "${key}" found but could not parse: ${err.message}
                </div>
              `;
            }
          }
        }

        if (!devicesFound) {
          deviceHtml = `
            <div class="error">
              <h4>‚ùå No devices found in localStorage!</h4>
              <p>Checked keys: ${possibleKeys.join(', ')}</p>
              <p><strong>Action needed:</strong> Import devices using import-devices.html</p>
            </div>
          `;
        }

        deviceAnalysis.innerHTML = deviceHtml;

        // Analyze favorites
        let favoritesHtml = '';
        const favoriteKeys = ['favorite-devices', 'kv:favorite-devices'];

        for (const key of favoriteKeys) {
          const favJson = localStorage.getItem(key);
          if (favJson) {
            try {
              const favorites = JSON.parse(favJson);
              favoritesHtml += `
                <div class="success">
                  <h4>‚úÖ Favorites found at key: "${key}"</h4>
                  <pre>${JSON.stringify(favorites, null, 2)}</pre>
                  <p><strong>Count:</strong> ${Array.isArray(favorites) ? favorites.length : 'Not an array'}</p>
                </div>
              `;
            } catch (err) {
              favoritesHtml += `
                <div class="warning">
                  Key "${key}" found but could not parse: ${err.message}
                </div>
              `;
            }
          }
        }

        if (!favoritesHtml) {
          favoritesHtml = `
            <div class="warning">
              <h4>‚ö†Ô∏è No favorites found</h4>
              <p>Checked keys: ${favoriteKeys.join(', ')}</p>
              <p><strong>This is why no devices show in the favorites tool!</strong></p>
            </div>
          `;
        }

        favoritesData.innerHTML = favoritesHtml;
      }

      function addDefaultFavorites() {
        try {
          // Get devices
          const devicesJson = localStorage.getItem('kv:devices') || localStorage.getItem('devices');
          if (!devicesJson) {
            alert('‚ùå No devices found! Please import devices first.');
            return;
          }

          const devices = JSON.parse(devicesJson);
          const hueDevices = devices.filter(d => d.protocol === 'hue' && d.status === 'online');

          if (hueDevices.length === 0) {
            alert('‚ùå No online Hue devices found!');
            return;
          }

          // Select first 5 Extended Color devices, or just first 5
          const extendedColor = hueDevices.filter(d =>
            d.capabilities?.includes('color') &&
            d.capabilities?.includes('dimming') &&
            d.capabilities?.includes('color-temp')
          );

          const favoritesDevices = extendedColor.length >= 5
            ? extendedColor.slice(0, 5)
            : hueDevices.slice(0, 5);

          const favoriteIds = favoritesDevices.map(d => d.id);

          // Save to both keys
          localStorage.setItem('favorite-devices', JSON.stringify(favoriteIds));
          localStorage.setItem('kv:favorite-devices', JSON.stringify(favoriteIds));

          alert(`‚úÖ Added ${favoriteIds.length} devices to favorites:\n\n${favoritesDevices.map(d => d.name).join('\n')}\n\nRefresh the page to see updated data.`);
          location.reload();

        } catch (err) {
          alert('‚ùå Error adding favorites: ' + err.message);
          console.error(err);
        }
      }

      function copyToConsole() {
        const data = {
          keys: Object.keys(localStorage),
          devices: null,
          favorites: null
        };

        try {
          const devicesJson = localStorage.getItem('kv:devices') || localStorage.getItem('devices');
          if (devicesJson) {
            data.devices = JSON.parse(devicesJson);
          }
        } catch (e) {}

        try {
          const favJson = localStorage.getItem('kv:favorite-devices') || localStorage.getItem('favorite-devices');
          if (favJson) {
            data.favorites = JSON.parse(favJson);
          }
        } catch (e) {}

        console.log('HomeHub localStorage Data:', data);
        alert('‚úÖ Data logged to console! Open DevTools (F12) to see.');
      }

      // Run analysis on load
      analyzeLocalStorage();
    </script>
  </body>
</html>
